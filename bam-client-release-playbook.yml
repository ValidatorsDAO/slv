---
# Builds (from jito-labs/bam-client) and uploads BAM Client artifacts to Cloudflare R2.
# Usage: ansible-playbook -i inventory.yml bam-client-release-playbook.yml [-e "version=v3.1.4-bam"]
- name: Build and upload BAM Client to R2
  hosts: all
  gather_facts: yes
  vars:
    bam_version: "{{ version | default('') }}"
    bam_releases_url: "https://api.github.com/repos/jito-labs/bam-client/releases"
    bam_repo_url: "https://github.com/jito-labs/bam-client.git"
    build_dir: "/tmp/bam-client-build-{{ bam_version | default('latest') }}"
    artifact_name: "{{ bam_client_asset_name | default('bam-client-' ~ bam_version ~ '.tar.gz') }}"
    artifact_path: "/tmp/{{ artifact_name }}"
    storage_prefix: "bam-client"
    force_build: false
    expected_bins:
      - solana
      - solana-keygen
      - agave-validator
      - solana-test-validator
      - solana-faucet
    include_perf_libs: true
    bucket_names:
      - slv
      - slv-asia
    cloudflare_account_id: "{{ lookup('env', 'CLOUDFLARE_ACCOUNT_ID') | default(lookup('ini', 'CLOUDFLARE_ACCOUNT_ID file=.env type=properties default='''), true) }}"
    cloudflare_api_token: "{{ lookup('env', 'CLOUDFLARE_API_TOKEN') | default(lookup('ini', 'CLOUDFLARE_API_TOKEN file=.env type=properties default='''), true) }}"
    discord_webhook_url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') | default(lookup('ini', 'DISCORD_WEBHOOK_URL file=.env type=properties default='''), true) }}"

  tasks:
    - name: Validate required environment variables
      assert:
        that:
          - cloudflare_account_id != ''
          - cloudflare_api_token != ''
        fail_msg: "CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN must be set"

    - name: Install dependencies (Debian/Ubuntu)
      become: yes
      apt:
        name:
          - curl
          - jq
          - git
          - build-essential
          - pkg-config
          - libssl-dev
          - libudev-dev
          - libclang-dev
          - cmake
          - protobuf-compiler
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Check if Rust is installed
      command: rustc --version
      register: rust_check
      ignore_errors: yes
      changed_when: false

    - name: Install Rust if not present
      shell: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
      args:
        executable: /bin/bash
      when: rust_check.rc != 0

    - name: Ensure Rust is in PATH
      lineinfile:
        path: ~/.bashrc
        line: 'source $HOME/.cargo/env'
        create: yes
      when: rust_check.rc != 0

    - name: Fetch latest BAM Client releases (when version is not provided)
      uri:
        url: "{{ bam_releases_url }}"
        method: GET
        return_content: yes
      register: bam_release_list
      when: bam_version == ''

    - name: Select latest stable release
      set_fact:
        bam_release: "{{ (bam_release_list.json | selectattr('draft', 'equalto', false) | selectattr('prerelease', 'equalto', false) | list)[0] | default({}) }}"
      when: bam_version == ''

    - name: Fetch release by tag (when version is provided)
      uri:
        url: "https://api.github.com/repos/jito-labs/bam-client/releases/tags/{{ bam_version }}"
        method: GET
        return_content: yes
        status_code: [200, 404]
      register: bam_release_by_tag
      when: bam_version != ''

    - name: Use tagged release details
      set_fact:
        bam_release: "{{ bam_release_by_tag.json | default({}) }}"
      when: bam_version != ''

    - name: Set BAM Client version from release data
      set_fact:
        bam_version: "{{ bam_release.tag_name | default(bam_version) }}"

    - name: Validate version is set
      assert:
        that:
          - bam_version != ''
        fail_msg: "Failed to determine BAM Client version"

    - name: Compute artifact names and R2 key
      set_fact:
        artifact_name: "{{ bam_client_asset_name | default('bam-client-' ~ bam_version ~ '.tar.gz') }}"
        artifact_path: "/tmp/{{ bam_client_asset_name | default('bam-client-' ~ bam_version ~ '.tar.gz') }}"
        r2_key: "{{ storage_prefix }}/{{ bam_version }}/{{ bam_client_asset_name | default('bam-client-' ~ bam_version ~ '.tar.gz') }}"

    - name: Check artifact existence in R2 buckets
      uri:
        url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/{{ item }}/objects/{{ r2_key }}"
        method: GET
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
        status_code: [200, 404]
      register: r2_checks
      loop: "{{ bucket_names }}"
      changed_when: false

    - name: Decide if upload is needed
      set_fact:
        need_upload: "{{ force_build or ((r2_checks.results | selectattr('status', 'equalto', 200) | list | length) != (bucket_names | length)) }}"

    - name: Show status
      debug:
        msg: |
          BAM Client version: {{ bam_version }}
          Artifact: {{ artifact_name }}
          R2 key: {{ r2_key }}
          Need upload: {{ need_upload }} (force_build={{ force_build }})
      when: need_upload

    - block:
        - name: Clean up previous build directory if exists
          file:
            path: "{{ build_dir }}"
            state: absent

        - name: Clone bam-client repository
          git:
            repo: "{{ bam_repo_url }}"
            dest: "{{ build_dir }}"
            version: "{{ bam_version }}"
            recursive: yes
            force: yes

        - name: Build BAM Client binaries
          shell: |
            set -e
            source $HOME/.cargo/env
            cargo build --release --locked
          args:
            chdir: "{{ build_dir }}"
            executable: /bin/bash
          environment:
            RUST_BACKTRACE: 1

        - name: Ensure dist directory exists
          file:
            path: "{{ build_dir }}/dist"
            state: directory

        - name: Collect expected binaries
          shell: |
            set -e
            for name in {{ expected_bins | join(' ') }}; do
              if [ -f "{{ build_dir }}/target/release/${name}" ]; then
                echo "{{ build_dir }}/target/release/${name}"
              fi
            done
          register: found_bins
          changed_when: false

        - name: Stage binaries for packaging
          copy:
            src: "{{ item }}"
            dest: "{{ build_dir }}/dist/{{ item | basename }}"
            remote_src: yes
            mode: "0755"
          loop: "{{ found_bins.stdout_lines | select('match','.+') | list }}"

        - name: Ensure we have at least one staged binary
          assert:
            that:
              - (found_bins.stdout_lines | select('match','.+') | list | length) > 0
            fail_msg: "No expected binaries were built. Check bam-client repo or expected_bins."

        - name: Check for perf-libs directory or symlink
          stat:
            path: "{{ build_dir }}/target/release/perf-libs"
          register: perf_libs_stat
          when: include_perf_libs

        - name: Find real perf-libs directory
          shell: |
            cd {{ build_dir }}/target/release
            if [ -L perf-libs ]; then
              readlink -f perf-libs
            elif [ -d perf-libs ]; then
              echo "{{ build_dir }}/target/release/perf-libs"
            elif [ -d ../perf-libs ]; then
              echo "{{ build_dir }}/target/perf-libs"
            else
              echo ""
            fi
          register: real_perf_dir
          when: include_perf_libs
          changed_when: false

        - name: Build perf-libs if not found
          shell: |
            set -e
            source $HOME/.cargo/env
            if [ -f scripts/build-perf-libs.sh ]; then
              ./scripts/build-perf-libs.sh
            elif [ -f perf/build.sh ]; then
              cd perf && ./build.sh
            fi
          args:
            chdir: "{{ build_dir }}"
            executable: /bin/bash
          when: include_perf_libs and real_perf_dir.stdout == ""

        - name: Re-check for perf-libs after build
          shell: |
            cd {{ build_dir }}/target/release
            if [ -L perf-libs ]; then
              readlink -f perf-libs
            elif [ -d perf-libs ]; then
              echo "{{ build_dir }}/target/release/perf-libs"
            elif [ -d ../perf-libs ]; then
              echo "{{ build_dir }}/target/perf-libs"
            else
              echo ""
            fi
          register: real_perf_dir_final
          when: include_perf_libs and real_perf_dir.stdout == ""
          changed_when: false

        - name: Set final perf directory
          set_fact:
            perf_directory: "{{ real_perf_dir_final.stdout if real_perf_dir.stdout == '' else real_perf_dir.stdout }}"
          when: include_perf_libs

        - name: Stage perf-libs archive when available
          shell: |
            set -e
            if [ -f "{{ perf_directory }}/solana-perf.tgz" ]; then
              cp "{{ perf_directory }}/solana-perf.tgz" "{{ build_dir }}/dist/perf-libs.tar.gz"
            elif [ "{{ perf_directory }}" != "" ]; then
              tar -C "{{ perf_directory }}" -czf "{{ build_dir }}/dist/perf-libs.tar.gz" .
            fi
          args:
            executable: /bin/bash
          when: include_perf_libs and perf_directory is defined and perf_directory != ""

        - name: Create artifact archive
          shell: |
            set -e
            tar -C "{{ build_dir }}/dist" -czf "{{ artifact_path }}" .
          args:
            executable: /bin/bash

        - name: Upload artifact to R2 buckets
          shell: |
            for BUCKET_NAME in {{ bucket_names | join(' ') }}; do
              curl -s -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/${BUCKET_NAME}/objects/{{ r2_key }}" \
                -H "Authorization: Bearer {{ cloudflare_api_token }}" \
                -H "Content-Type: application/gzip" \
                --data-binary "@{{ artifact_path }}"
            done
          args:
            executable: /bin/bash
      when: need_upload

    - name: Update latest.txt in both buckets
      shell: |
        echo "{{ bam_version }}" > /tmp/bam-client-latest.txt
        for BUCKET_NAME in {{ bucket_names | join(' ') }}; do
          curl -s -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/${BUCKET_NAME}/objects/{{ storage_prefix }}/latest.txt" \
            -H "Authorization: Bearer {{ cloudflare_api_token }}" \
            -H "Content-Type: text/plain" \
            --data-binary "@/tmp/bam-client-latest.txt"
        done
      args:
        executable: /bin/bash
      when: need_upload

    - name: Send Discord notification
      uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          embeds:
            - title: "ðŸ“¦ New/Updated BAM Client release"
              description: "Built and uploaded {{ artifact_name }} to R2"
              color: 1127128
              fields:
                - name: "Version"
                  value: "{{ bam_version }}"
                  inline: true
                - name: "Download"
                  value: "https://storage.slv.dev/{{ r2_key }}"
                  inline: false
              timestamp: "{{ ansible_date_time.iso8601 }}"
        status_code: [200, 204]
      when: need_upload and discord_webhook_url != ''

    - name: Cleanup build artifacts
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ build_dir }}"
        - "{{ artifact_path }}"
        - /tmp/bam-client-latest.txt
      when: need_upload

    - name: Final message
      debug:
        msg: |
          {% if need_upload %}
          Built and uploaded BAM Client {{ bam_version }} to R2.
          {% else %}
          All BAM Client artifacts for {{ bam_version }} already exist in all buckets. No action taken.
          {% endif %}
