---
- name: Deploy yellowstone-faithful daemon (RPC + gRPC)
  hosts: all
  become: true
  gather_facts: yes
  vars:
    faithful_binary_path: "/home/solv/faithful-cli"
    faithful_workdir: "/home/solv"
    faithful_proxy_path: "/home/solv/proxy.yml"
    faithful_config_glob: "configs/*.yml"
    faithful_listen: ":8888"
    faithful_grpc_listen: ":8890"
    faithful_epoch_search_concurrency: 5
    faithful_epoch_load_concurrency: 10
    faithful_service_name: "faithful.service"

  tasks:
    - name: Verify faithful binary exists
      stat:
        path: "{{ faithful_binary_path }}"
      register: faithful_bin_stat

    - name: Fail if faithful binary is missing
      fail:
        msg: "faithful binary not found at {{ faithful_binary_path }}. Run install_of1.yml first."
      when: not faithful_bin_stat.stat.exists

    - name: Ensure workdir exists
      file:
        path: "{{ faithful_workdir }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"

    - name: Ensure configs directory exists
      file:
        path: "{{ faithful_workdir }}/configs"
        state: directory
        owner: solv
        group: solv
        mode: "0755"

    - name: Create faithful systemd service
      copy:
        dest: "/etc/systemd/system/{{ faithful_service_name }}"
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=yellowstone-faithful RPC/gRPC proxy
          After=network.target

          [Service]
          User=solv
          WorkingDirectory={{ faithful_workdir }}
          ExecStart={{ faithful_binary_path }} rpc --proxy={{ faithful_proxy_path }} --listen={{ faithful_listen }} --grpc-listen={{ faithful_grpc_listen }} --epoch-search-concurrency {{ faithful_epoch_search_concurrency }} --epoch-load-concurrency {{ faithful_epoch_load_concurrency }} {{ faithful_config_glob }}
          Restart=on-failure
          RestartSec=3

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      command: systemctl daemon-reload

    - name: Enable and restart faithful service
      systemd:
        name: "{{ faithful_service_name }}"
        enabled: true
        state: restarted
