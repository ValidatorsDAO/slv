---
- name: Install Richat Geyser plugin from hosted binary
  hosts: all
  vars_files:
    - ~/.slv/versions.yml
  become: true
  vars:
    richat_install_root: "/home/solv/richat-geyser"
    richat_current_link: "{{ richat_install_root }}/current"
    richat_lib_name: "librichat_plugin_agave.so"
    richat_symlink_path: "/home/solv/{{ richat_lib_name }}"
    richat_config_template: "~/.slv/mainnet-rpc/geyser-richat.json.j2"
    richat_config_path: "/home/solv/geyser.json"
  tasks:
    - name: Resolve richat plugin version and download URL (overridable via -e richat_version=)
      set_fact:
        richat_version_resolved: "{{ richat_version | default(mainnet_rpcs.richat_version | default('', true), true) }}"

    - name: Ensure richat_version is provided
      assert:
        that:
          - richat_version_resolved != ''
        fail_msg: "richat_version must be provided (via -e richat_version= or mainnet_rpcs.richat_version in ~/.slv/versions.yml)"

    - name: Set paths for Richat plugin
      set_fact:
        richat_release_dir: "{{ richat_install_root }}/releases/{{ richat_version_resolved }}"
        richat_download_url: "https://storage.slv.dev/richat/{{ richat_version_resolved | urlencode }}/{{ richat_lib_name }}"
        richat_download_dest: "{{ richat_install_root }}/releases/{{ richat_version_resolved }}/{{ richat_lib_name }}"

    - name: Ensure directories exist for Richat plugin
      file:
        path: "{{ item }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
      loop:
        - "{{ richat_install_root }}"
        - "{{ richat_install_root }}/releases"
        - "{{ richat_release_dir }}"

    - name: Download Richat plugin shared object
      get_url:
        url: "{{ richat_download_url }}"
        dest: "{{ richat_download_dest }}"
        mode: "0644"
        owner: solv
        group: solv
        force: yes
        timeout: 60
      retries: 3
      delay: 2

    - name: Point 'current' symlink to this Richat release
      file:
        src: "{{ richat_release_dir }}"
        dest: "{{ richat_current_link }}"
        state: link
        force: yes
        owner: solv
        group: solv

    - name: Symlink Richat plugin to stable path for geyser
      file:
        src: "{{ richat_download_dest }}"
        dest: "{{ richat_symlink_path }}"
        state: link
        force: yes
        owner: solv
        group: solv

    - name: Copy the geyser.json configuration file for Richat
      template:
        src: "{{ richat_config_template }}"
        dest: "{{ richat_config_path }}"
        owner: solv
        group: solv
        mode: "0644"
