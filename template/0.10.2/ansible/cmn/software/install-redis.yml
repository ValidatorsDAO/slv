---
- name: Install and configure Redis
  hosts: all
  become: yes
  vars:
    redis_conf_path: '/etc/redis/redis.conf'
    redis_data_dir: '/var/lib/redis'
  tasks:
    # 1. Ubuntuバージョンに応じた設定の調整
    - name: Detect Ubuntu version
      shell: lsb_release -sc
      register: ubuntu_version
      changed_when: false

    # 2. 必要に応じてリポジトリを更新
    - name: Update repository for older Ubuntu versions
      shell: |
        if [[ "{{ ubuntu_version.stdout }}" == "noble" ]]; then
          sed -i 's/noble/jammy/g' /etc/apt/sources.list.d/*.list
        fi
      when: ubuntu_version.stdout == "noble"
      become: yes

    # 3. Redisのインストール
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Redis
      apt:
        name: redis-server
        state: present

    # 4. Redis設定のバックアップ
    - name: Backup original Redis configuration
      copy:
        src: '{{ redis_conf_path }}'
        dest: '{{ redis_conf_path }}.bak'
        remote_src: yes
        owner: root
        group: root
        mode: '0644'

    # 5. Redis設定の更新
    - name: Update Redis configuration for persistence
      lineinfile:
        path: '{{ redis_conf_path }}'
        regexp: '^save .*'
        line: 'save 900 1'
        state: present
      notify: Restart Redis

    - name: Enable appendonly mode
      lineinfile:
        path: '{{ redis_conf_path }}'
        regexp: '^appendonly .*'
        line: 'appendonly yes'
        state: present
      notify: Restart Redis

    - name: Set Redis bind address
      lineinfile:
        path: '{{ redis_conf_path }}'
        regexp: '^bind .*'
        line: 'bind 127.0.0.1'
        state: present
      notify: Restart Redis

    - name: Set Redis protected mode
      lineinfile:
        path: '{{ redis_conf_path }}'
        regexp: '^protected-mode .*'
        line: 'protected-mode yes'
        state: present
      notify: Restart Redis

    - name: Set Redis data directory
      lineinfile:
        path: '{{ redis_conf_path }}'
        regexp: '^dir .*'
        line: 'dir {{ redis_data_dir }}/'
        state: present
      notify: Restart Redis

    # 6. 永続化ディレクトリの権限確認
    - name: Ensure Redis data directory permissions
      file:
        path: '{{ redis_data_dir }}'
        owner: redis
        group: redis
        state: directory
        mode: '0755'

    # 7. Redisサービスの有効化と起動
    - name: Enable and start Redis service
      systemd:
        name: redis-server
        enabled: yes
        state: started

  handlers:
    - name: Restart Redis
      systemd:
        name: redis-server
        state: restarted
