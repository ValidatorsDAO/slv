---
- name: Install and run Richat daemon
  hosts: all
  become: true
  vars_files:
    - ~/.slv/versions.yml
  vars:
    richat_install_dir: "/home/solv"
    richat_binary_path: "{{ richat_install_dir }}/richat"
    richat_config_template: "~/.slv/mainnet-rpc/richat-setting.yml.j2"
    richat_config_path: "/home/solv/richat-config.yml"
    richat_service_template: "~/.slv/mainnet-rpc/richat.service.j2"
    richat_service_path: "/etc/systemd/system/richat.service"

  tasks:
    - name: Resolve richat version (override with -e richat_version=)
      set_fact:
        richat_version_resolved: "{{ richat_version | default(mainnet_rpcs.richat_version | default('', true), true) }}"

    - name: Ensure richat version is provided
      assert:
        that:
          - richat_version_resolved != ''
        fail_msg: "richat_version must be provided (via -e richat_version= or mainnet_rpcs.richat_version in ~/.slv/versions.yml)"

    - name: Build download URL for richat binary
      set_fact:
        richat_download_url: "https://storage.slv.dev/richat/{{ richat_version_resolved | urlencode }}/richat"

    - name: Ensure directories for richat exist
      file:
        path: "{{ item }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
      loop:
        - "{{ richat_install_dir }}"

    - name: Download richat binary
      get_url:
        url: "{{ richat_download_url }}"
        dest: "{{ richat_binary_path }}"
        mode: "0755"
        owner: solv
        group: solv
        force: yes
        timeout: 60
      retries: 3
      delay: 2

    - name: Deploy richat config
      template:
        src: "{{ richat_config_template }}"
        dest: "{{ richat_config_path }}"
        owner: solv
        group: solv
        mode: "0644"

    - name: Deploy richat systemd service
      template:
        src: "{{ richat_service_template }}"
        dest: "{{ richat_service_path }}"
        owner: root
        group: root
        mode: "0644"

    - name: Reload systemd daemon
      command: systemctl daemon-reload

    - name: Enable and start richat service
      systemd:
        name: richat.service
        enabled: true
        state: restarted
