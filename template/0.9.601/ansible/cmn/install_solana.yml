---
- name: Install/Update Solana CLI (agave or jito) from hosted binaries
  hosts: all
  become: true
  vars:
    # ==== Args: -e "validator_type=jito version=v3.0.7 region=tokyo" ====
    # validator_type can be: agave, jito, firedancer-agave, or firedancer-jito
    # If not provided, defaults to "agave"
    # Default values if not provided via inventory or -e
    default_version: "v3.0.7"
    default_region: "frankfurt"        # default region. use "tokyo" or "singapore" to switch to storage-asia

    # These are computed later via set_fact (don't change here)
    install_root: "/opt/{{ solana_cli_type }}"
    release_dir: "{{ install_root }}/releases/{{ version }}"
    bin_release_dir: "{{ release_dir }}/bin"
    current_link: "{{ install_root }}/current"
    solana_release_dir: "/home/solv/.local/share/solana/install/active_release"
    solana_bin_dir: "{{ solana_release_dir }}/bin"

    binaries:
      - agave-validator
      - solana
      - solana-keygen

    # Jito specific: perf-libs archive
    perf_libs_archive: "perf-libs.tar.gz"
    perf_libs_dir: "{{ release_dir }}/perf-libs"

    # If true, missing binaries won't fail the run (allows agave-only or jito-only artifacts to pass)
    ignore_missing_binaries: true

  tasks:
    - name: Load versions.yml
      include_vars:
        file: ~/.slv/versions.yml
        name: slv_versions

    - name: Get group names for current host
      set_fact:
        host_groups: "{{ group_names }}"

    - name: Find the matching group from versions.yml
      set_fact:
        matched_group: "{{ item }}"
      when: item in slv_versions
      loop: "{{ host_groups }}"

    - name: Debug - Show matched group and available versions
      debug:
        msg: "Matched group: {{ matched_group | default('none') }}, Available versions: {{ slv_versions[matched_group] | default({}) }}"
      when: matched_group is defined

    - name: Determine solana_cli_type based on validator_type
      set_fact:
        solana_cli_type: "{{ 'jito' if 'jito' in (validator_type | default('agave')) else 'agave' }}"

    - name: Set version from versions.yml based on validator_type
      set_fact:
        version: >-
          {%- if matched_group is defined -%}
            {%- if 'jito' in (validator_type | default('')) -%}
              v{{ slv_versions[matched_group]['version_jito'] }}
            {%- else -%}
              v{{ slv_versions[matched_group]['version_agave'] }}
            {%- endif -%}
          {%- else -%}
            {{ version | default(default_version) }}
          {%- endif -%}

    - name: Set region with default
      set_fact:
        region: "{{ region | default(default_region) }}"

    - name: Show determined CLI type
      debug:
        msg: "validator_type={{ validator_type | default('agave') }} -> solana_cli_type={{ solana_cli_type }}"

    - name: Validate solana_cli_type
      assert:
        that:
          - solana_cli_type in ['agave', 'jito']
        fail_msg: "solana_cli_type must be 'agave' or 'jito'. Got: {{ solana_cli_type }}"

    - name: Validate version looks like vX.Y.Z (warning only)
      debug:
        msg: "Using version={{ version }} (make sure it matches your storage layout, e.g. v3.0.7)"

    - name: Compute download host per region
      set_fact:
        download_host: "{{ 'storage-asia.slv.dev' if (region | lower) in ['tokyo','singapore'] else 'storage.slv.dev' }}"

    - name: Compute download base URL
      set_fact:
        download_base: "https://{{ download_host }}/{{ solana_cli_type }}/{{ version }}"

    - name: Show resolved download source
      debug:
        msg: "Region={{ region | lower }}, using host={{ download_host }}, base={{ download_base }}"

    - name: Ensure directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
      loop:
        - "{{ install_root }}"
        - "{{ install_root }}/releases"
        - "{{ release_dir }}"
        - "{{ bin_release_dir }}"
        - "{{ solana_bin_dir }}"

    - name: Detect current linked release (if any)
      stat:
        path: "{{ current_link }}"
        follow: false
      register: current_link_stat

    - name: Read link target of current
      command: readlink -f "{{ current_link }}"
      register: current_target
      changed_when: false
      failed_when: false
      when: current_link_stat.stat.islnk is defined and current_link_stat.stat.islnk

    - name: Decide if update is required
      set_fact:
        update_required: "{{ (current_target.stdout | default('')) != release_dir }}"

    - name: Download binaries into versioned bin dir
      get_url:
        url: "{{ download_base }}/{{ item }}"
        dest: "{{ bin_release_dir }}/{{ item }}"
        mode: "0755"
        force: yes
        # checksum: "sha256:{{ lookup('url', download_base ~ '/' ~ item ~ '.sha256', split_lines=False) | default('') }}"
        timeout: 60
      loop: "{{ binaries }}"
      register: dl_results
      failed_when: >
        (not ignore_missing_binaries) and
        (dl_results is failed)
      ignore_errors: "{{ ignore_missing_binaries }}"
      retries: 3
      delay: 2

    - name: Build list of successfully downloaded binaries
      set_fact:
        downloaded_bins: >-
          {{
            (dl_results.results | default([]))
            | selectattr('failed','!=',True)
            | map(attribute='item')
            | list
          }}

    - name: Ensure we have at least one binary
      assert:
        that:
          - downloaded_bins | length > 0
        fail_msg: "No binaries were downloaded. Check URLs, version, or binary names."

    # ==== Jito-specific: Download and extract perf-libs ====
    - name: Download perf-libs archive (Jito only)
      get_url:
        url: "{{ download_base }}/{{ perf_libs_archive }}"
        dest: "/tmp/{{ perf_libs_archive }}"
        mode: "0644"
        force: yes
        timeout: 120
      when: solana_cli_type == "jito"
      register: perf_libs_download
      ignore_errors: yes
      retries: 3
      delay: 2

    - name: Extract perf-libs archive (Jito only)
      unarchive:
        src: "/tmp/{{ perf_libs_archive }}"
        dest: "{{ release_dir }}/"
        remote_src: yes
        owner: solv
        group: solv
      when:
        - solana_cli_type == "jito"
        - perf_libs_download is defined
        - perf_libs_download is not failed

    - name: Ensure perf-libs has proper permissions (Jito only)
      file:
        path: "{{ perf_libs_dir }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
        recurse: yes
      when:
        - solana_cli_type == "jito"
        - perf_libs_download is defined
        - perf_libs_download is not failed

    - name: Create symlink for perf-libs in bin directory (Jito only)
      file:
        src: "{{ perf_libs_dir }}"
        dest: "{{ bin_release_dir }}/perf-libs"
        state: link
        force: yes
      when:
        - solana_cli_type == "jito"
        - perf_libs_download is defined
        - perf_libs_download is not failed

    - name: Clean up perf-libs archive
      file:
        path: "/tmp/{{ perf_libs_archive }}"
        state: absent
      when: solana_cli_type == "jito"

    - name: Point 'current' symlink to this release (atomic flip)
      file:
        src: "{{ release_dir }}"
        dest: "{{ current_link }}"
        state: link
        force: yes

    - name: Link binaries into active_release/bin
      file:
        src: "{{ bin_release_dir }}/{{ item }}"
        dest: "{{ solana_bin_dir }}/{{ item }}"
        state: link
        force: yes
      loop: "{{ downloaded_bins }}"

    - name: Ensure PATH line exists in /home/solv/.profile
      become: no
      lineinfile:
        path: "/home/solv/.profile"
        line: "export PATH={{ solana_bin_dir }}:$PATH"
        state: present
        create: yes

    - name: Verify versions
      become: no
      shell: |
        set -e
        if [ -x "{{ solana_bin_dir }}/solana" ]; then "{{ solana_bin_dir }}/solana" --version || true; fi
        if [ -x "{{ solana_bin_dir }}/agave-validator" ]; then "{{ solana_bin_dir }}/agave-validator" --version || true; fi
      args:
        executable: /bin/bash
      register: version_check
      changed_when: false
      failed_when: false

    - name: Show version outputs
      debug:
        var: version_check.stdout
