---
- name: Install/Update Solana CLI (agave, jito, or jito-bam) from hosted binaries
  hosts: all
  become: true
  vars:
    # ==== Args: -e "validator_type=jito version=v3.0.7 region=tokyo" ====
    # validator_type can be: agave, jito, firedancer-agave, or firedancer-jito
    # If not provided, defaults to "agave"
    # Default values if not provided via inventory or -e
    default_version: "v3.0.12"
    default_region: "frankfurt" # default region. use "tokyo" or "singapore" to switch to storage-asia

    # These are computed later via set_fact (don't change here)
    install_root: "/opt/{{ solana_cli_type }}"
    release_dir: "{{ install_root }}/releases/{{ version }}"
    bin_release_dir: "{{ release_dir }}/bin"
    current_link: "{{ install_root }}/current"
    solana_release_dir: "/home/solv/.local/share/solana/install/active_release"
    solana_bin_dir: "{{ solana_release_dir }}/bin"

    binaries:
      - agave-validator
      - solana
      - solana-keygen

    # Jito specific: perf-libs archive
    perf_libs_archive: "perf-libs.tar.gz"
    perf_libs_dir: "{{ release_dir }}/perf-libs"

    # If true, missing binaries won't fail the run (allows agave-only or jito-only artifacts to pass)
    ignore_missing_binaries: true
    bam_storage_prefix: "bam-client"
    bam_release_api_base: "https://api.github.com/repos/jito-labs/bam-client/releases/tags"
    bam_expected_bins:
      - solana
      - solana-keygen
      - agave-validator
    bam_optional_bins:
      - bam
      - bam-client

  tasks:
    - name: Load versions.yml
      include_vars:
        file: ~/.slv/versions.yml
        name: slv_versions

    - name: Get group names for current host
      set_fact:
        host_groups: "{{ group_names }}"

    - name: Find the matching group from versions.yml
      set_fact:
        matched_group: "{{ item }}"
      when: item in slv_versions
      loop: "{{ host_groups }}"

    - name: Debug - Show matched group and available versions
      debug:
        msg: "Matched group: {{ matched_group | default('none') }}, Available versions: {{ slv_versions[matched_group] | default({}) }}"
      when: matched_group is defined

    - name: Determine solana_cli_type based on validator_type
      set_fact:
        solana_cli_type: >-
          {{
            solana_cli_type
            | default(
                'jito-bam' if 'jito-bam' in (validator_type | default('')) else
                ('jito' if 'jito' in (validator_type | default('agave')) else 'agave')
              )
          }}

    - name: Set region with default
      set_fact:
        region: "{{ region | default(default_region) }}"

    - name: Show determined CLI type
      debug:
        msg: "validator_type={{ validator_type | default('agave') }} -> solana_cli_type={{ solana_cli_type }}"

    - name: Validate solana_cli_type
      assert:
        that:
          - solana_cli_type in ['agave', 'jito', 'jito-bam']
        fail_msg: "solana_cli_type must be 'agave', 'jito', or 'jito-bam'. Got: {{ solana_cli_type }}"

    - name: Compute download host per region
      set_fact:
        download_host: "{{ 'storage-asia.slv.dev' if (region | lower) in ['tokyo','singapore'] else 'storage.slv.dev' }}"

    - name: Set version from versions.yml for agave
      set_fact:
        version: "v{{ slv_versions[matched_group]['version_agave'] }}"
      when:
        - (version is not defined) or (version == '')
        - matched_group is defined
        - solana_cli_type == 'agave'
        - slv_versions[matched_group]['version_agave'] is defined

    - name: Set version from versions.yml for jito
      set_fact:
        version: "v{{ slv_versions[matched_group]['version_jito'] }}"
      when:
        - (version is not defined) or (version == '')
        - matched_group is defined
        - solana_cli_type == 'jito'
        - slv_versions[matched_group]['version_jito'] is defined

    - name: Set version from versions.yml for jito-bam
      vars:
        bam_version: "{{ slv_versions[matched_group]['version_jito_bam'] | default(slv_versions[matched_group]['version_bam'] | default('')) | trim }}"
      set_fact:
        version: "{{ ('v' ~ bam_version) if (bam_version | length > 0) else '' }}"
      when:
        - (version is not defined) or (version == '')
        - matched_group is defined
        - solana_cli_type == 'jito-bam'
        - bam_version | length > 0

    - name: Set default version when still unset (agave/jito)
      set_fact:
        version: "{{ default_version }}"
      when:
        - (version is not defined) or (version == '')
        - solana_cli_type in ['agave', 'jito', 'jito-bam']

    - name: Fetch latest BAM Client version from storage when needed
      uri:
        url: "https://{{ download_host }}/{{ bam_storage_prefix }}/latest.txt"
        method: GET
        return_content: yes
        status_code: 200
      register: bam_latest
      when:
        - solana_cli_type == 'jito-bam'
        - (version is not defined) or (version == '') or (version == 'latest')

    - name: Set BAM Client version from latest.txt
      set_fact:
        version: "{{ bam_latest.content | default('') | trim }}"
      when:
        - solana_cli_type == 'jito-bam'
        - bam_latest is defined
        - not bam_latest.skipped

    - name: Ensure version is set
      assert:
        that:
          - version is defined
          - version | length > 0
        fail_msg: 'version could not be determined. Provide -e "version=vX.Y.Z" or ensure metadata exists.'

    - name: Validate version looks like vX.Y.Z (warning only)
      debug:
        msg: "Using version={{ version }} (make sure it matches your storage layout, e.g. v3.0.7)"

    - name: Default BAM Client asset name from version
      set_fact:
        bam_client_asset_name: "{{ bam_client_asset_name | default('bam-client-' ~ version ~ '.tar.gz') }}"
      when: solana_cli_type == 'jito-bam'

    - name: Compute download base URL
      set_fact:
        download_base: >-
          {% if solana_cli_type == 'jito-bam' -%}
            https://{{ download_host }}/{{ bam_storage_prefix }}/{{ version }}
          {%- else -%}
            https://{{ download_host }}/{{ solana_cli_type }}/{{ version }}
          {%- endif %}

    - name: Show resolved download source
      debug:
        msg: "Region={{ region | lower }}, using host={{ download_host }}, base={{ download_base }}"

    - name: Ensure directories exist
      file:
        path: "{{ item }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
      loop:
        - "{{ install_root }}"
        - "{{ install_root }}/releases"
        - "{{ release_dir }}"
        - "{{ bin_release_dir }}"
        - "{{ solana_bin_dir }}"

    - name: Detect current linked release (if any)
      stat:
        path: "{{ current_link }}"
        follow: false
      register: current_link_stat

    - name: Read link target of current
      command: readlink -f "{{ current_link }}"
      register: current_target
      changed_when: false
      failed_when: false
      when: current_link_stat.stat.islnk is defined and current_link_stat.stat.islnk

    - name: Decide if update is required
      set_fact:
        update_required: "{{ (current_target.stdout | default('')) != release_dir }}"

    - block:
        - name: Download binaries into versioned bin dir
          get_url:
            url: "{{ download_base }}/{{ item }}"
            dest: "{{ bin_release_dir }}/{{ item }}"
            mode: "0755"
            force: yes
            # checksum: "sha256:{{ lookup('url', download_base ~ '/' ~ item ~ '.sha256', split_lines=False) | default('') }}"
            timeout: 60
          loop: "{{ binaries }}"
          register: dl_results
          failed_when: >
            (not ignore_missing_binaries) and
            (dl_results is failed)
          ignore_errors: "{{ ignore_missing_binaries }}"
          retries: 3
          delay: 2

        - name: Build list of successfully downloaded binaries
          set_fact:
            downloaded_bins: >-
              {{
                (dl_results.results | default([]))
                | selectattr('failed','!=',True)
                | map(attribute='item')
                | list
              }}

        - name: Build list of downloaded binary paths
          set_fact:
            downloaded_bin_paths: >-
              {{
                (dl_results.results | default([]))
                | selectattr('failed','!=',True)
                | selectattr('dest','defined')
                | map(attribute='dest')
                | list
              }}
      when: solana_cli_type != 'jito-bam'

    - block:
        - name: Fetch BAM Client release metadata for version
          uri:
            url: "{{ bam_release_api_base }}/{{ version }}"
            method: GET
            return_content: yes
            status_code: 200
            headers:
              Accept: "application/vnd.github+json"
              User-Agent: "slv-ansible"
          register: bam_release_meta
          when:
            - bam_client_asset_name is not defined or bam_client_asset_name == ''

        - name: Set BAM Client asset name
          set_fact:
            bam_client_asset_name: "{{ (bam_release_meta.json.assets | default([]) | first | default({})).name | default('') }}"
          when:
            - bam_client_asset_name is not defined or bam_client_asset_name == ''

        - name: Ensure BAM Client asset name is resolved
          assert:
            that:
              - bam_client_asset_name is defined
              - bam_client_asset_name | length > 0
            fail_msg: "Unable to determine BAM Client asset name for version {{ version }}."

        - name: Download BAM Client artifact from storage
          get_url:
            url: "{{ download_base }}/{{ bam_client_asset_name }}"
            dest: "/tmp/{{ bam_client_asset_name }}"
            mode: "0644"
            force: yes
            timeout: 120
            headers:
              Cache-Control: "no-cache"
          register: bam_download

        - name: Detect whether BAM artifact is an archive
          set_fact:
            bam_is_archive: "{{ (bam_client_asset_name | regex_search('(\\.tar\\.gz|\\.tgz|\\.zip|\\.tar)$')) is not none }}"

        - name: Extract BAM Client archive
          unarchive:
            src: "/tmp/{{ bam_client_asset_name }}"
            dest: "{{ release_dir }}/"
            remote_src: yes
            owner: solv
            group: solv
          when:
            - bam_is_archive

        - name: Place BAM Client binary into bin dir when not an archive
          copy:
            src: "/tmp/{{ bam_client_asset_name }}"
            dest: "{{ bin_release_dir }}/{{ bam_client_asset_name }}"
            remote_src: yes
            owner: solv
            group: solv
            mode: "0755"
          when:
            - bam_is_archive is not defined or not bam_is_archive

        - name: Find BAM Client executables (expected names)
          shell: |
            set -e
            find {{ release_dir }} -maxdepth 6 -type f \( {% for n in bam_expected_bins + bam_optional_bins %}-name '{{ n }}'{% if not loop.last %} -o {% endif %}{% endfor %} \)
          register: bam_execs
          changed_when: false

        - name: Stage BAM Client binaries into bin dir
          copy:
            src: "{{ item }}"
            dest: "{{ bin_release_dir }}/{{ item | basename }}"
            remote_src: yes
            owner: solv
            group: solv
            mode: "0755"
          loop: "{{ bam_execs.stdout_lines | select('match','.+') | list }}"

        - name: Set downloaded BAM binary paths
          set_fact:
            downloaded_bin_paths: >-
              {{
                bam_execs.stdout_lines
                | select('match','.+')
                | map('basename')
                | map('regex_replace', '^', bin_release_dir ~ '/')
                | list
              }}
            downloaded_bins: "{{ bam_execs.stdout_lines | select('match','.+') | map('basename') | list }}"

        - name: Clean up BAM Client artifact
          file:
            path: "/tmp/{{ bam_client_asset_name }}"
            state: absent
      when: solana_cli_type == 'jito-bam'

    - name: Ensure we have at least one binary
      assert:
        that:
          - downloaded_bin_paths | default([]) | length > 0
        fail_msg: >-
          No binaries were staged. For jito-bam expected one of: {{ (bam_expected_bins + bam_optional_bins) | join(', ') }}.
          Check the BAM artifact URL/contents or provide bam_client_asset_name.

    - name: Ensure perf-libs directory exists (Jito/Jito-bam)
      file:
        path: "{{ perf_libs_dir }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
      when: solana_cli_type in ["jito", "jito-bam"]

    # ==== Jito-specific: Download and extract perf-libs ====
    - name: Download perf-libs archive (Jito only)
      get_url:
        url: "{{ download_base }}/{{ perf_libs_archive }}"
        dest: "/tmp/{{ perf_libs_archive }}"
        mode: "0644"
        force: yes
        timeout: 120
      when: solana_cli_type == "jito"
      register: perf_libs_download
      ignore_errors: yes
      retries: 3
      delay: 2

    - name: Extract perf-libs archive (Jito only)
      unarchive:
        src: "/tmp/{{ perf_libs_archive }}"
        dest: "{{ perf_libs_dir }}/"
        remote_src: yes
        owner: solv
        group: solv
      when:
        - solana_cli_type == "jito"
        - perf_libs_download is defined
        - perf_libs_download is not failed

    - name: Ensure perf-libs has proper permissions (Jito only)
      file:
        path: "{{ perf_libs_dir }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
        recurse: yes
      when:
        - solana_cli_type == "jito"
        - perf_libs_download is defined
        - perf_libs_download is not failed

    - name: Create symlink for perf-libs in bin directory (Jito only)
      file:
        src: "{{ perf_libs_dir }}"
        dest: "{{ bin_release_dir }}/perf-libs"
        state: link
        force: yes
      when:
        - solana_cli_type == "jito"
        - perf_libs_download is defined
        - perf_libs_download is not failed

    - name: Clean up perf-libs archive
      file:
        path: "/tmp/{{ perf_libs_archive }}"
        state: absent
      when: solana_cli_type == "jito"

    # ==== Jito-bam: use bundled perf-libs if present in the artifact ====
    - name: Check for bundled perf-libs archive (Jito-bam only)
      stat:
        path: "{{ release_dir }}/{{ perf_libs_archive }}"
      register: bam_perf_libs_stat
      when: solana_cli_type == "jito-bam"

    - name: Extract bundled perf-libs archive (Jito-bam only)
      unarchive:
        src: "{{ release_dir }}/{{ perf_libs_archive }}"
        dest: "{{ perf_libs_dir }}/"
        remote_src: yes
        owner: solv
        group: solv
      when:
        - solana_cli_type == "jito-bam"
        - bam_perf_libs_stat.stat.exists

    - name: Ensure perf-libs has proper permissions (Jito-bam only)
      file:
        path: "{{ perf_libs_dir }}"
        state: directory
        owner: solv
        group: solv
        mode: "0755"
        recurse: yes
      when:
        - solana_cli_type == "jito-bam"
        - bam_perf_libs_stat.stat.exists

    - name: Create symlink for perf-libs in bin directory (Jito-bam only)
      file:
        src: "{{ perf_libs_dir }}"
        dest: "{{ bin_release_dir }}/perf-libs"
        state: link
        force: yes
      when:
        - solana_cli_type == "jito-bam"
        - bam_perf_libs_stat.stat.exists

    - name: Point 'current' symlink to this release (atomic flip)
      file:
        src: "{{ release_dir }}"
        dest: "{{ current_link }}"
        state: link
        force: yes

    - name: Clear old symlinks before linking fresh binaries
      file:
        path: "{{ solana_bin_dir }}/{{ item }}"
        state: absent
      loop:
        - solana
        - solana-keygen
        - agave-validator
        - bam
        - bam-client

    - name: Link binaries into active_release/bin
      file:
        src: "{{ item }}"
        dest: "{{ solana_bin_dir }}/{{ item | basename }}"
        state: link
        force: yes
      loop: "{{ downloaded_bin_paths | default([]) }}"

    - name: Ensure PATH line exists in /home/solv/.profile
      become: no
      lineinfile:
        path: "/home/solv/.profile"
        line: "export PATH={{ solana_bin_dir }}:$PATH"
        state: present
        create: yes

    - name: Verify versions
      become: no
      shell: |
        set -e
        if [ -x "{{ solana_bin_dir }}/solana" ]; then "{{ solana_bin_dir }}/solana" --version || true; fi
        if [ -x "{{ solana_bin_dir }}/agave-validator" ]; then "{{ solana_bin_dir }}/agave-validator" --version || true; fi
        if [ -x "{{ solana_bin_dir }}/bam" ]; then "{{ solana_bin_dir }}/bam" --version || true; fi
        if [ -x "{{ solana_bin_dir }}/bam-client" ]; then "{{ solana_bin_dir }}/bam-client" --version || true; fi
      args:
        executable: /bin/bash
      register: version_check
      changed_when: false
      failed_when: false

    - name: Show version outputs
      debug:
        var: version_check.stdout
