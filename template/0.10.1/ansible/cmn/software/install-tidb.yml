---
- name: Deploy TiDB on single Ubuntu host (single-node, tiup cluster)
  hosts: all
  become: true
  vars:
    # 初回や壊れた時は true でフルクリーン（停止→破棄→クリーン→ディレクトリ再作成）
    reset: true

    tidb_user: "solv"
    tidb_deploy_dir: "/tidb-deploy" # ← ext4/xfs 上にしてください
    tidb_data_dir: "/tidb-data" # ← ext4/xfs 上にしてください
    tidb_version: "v8.5.3"
    tiup_install_script_url: "https://tiup-mirrors.pingcap.com/install.sh"
    tiup_bin_path: "/home/solv/.tiup/bin/tiup"
    cluster_name: "solv-tidb"
    tiup_identity_file: "/home/{{ tidb_user }}/.ssh/id_ed25519"
    tiup_env:
      TIUP_CLUSTER_SSH_KEY: "{{ tiup_identity_file }}"
      TIUP_SSH_IDENTITY_FILE: "{{ tiup_identity_file }}"

    # 単機用ポート
    pd_client_port: 7301
    pd_peer_port: 7302
    tikv_port: 20160
    tikv_status_port: 20180
    tidb_sql_port: 4000
    tidb_status_port: 10080
    tiflash_tcp: 9000
    tiflash_http: 8123
    tiflash_metrics: 8234
    tiflash_service: 3930

  pre_tasks:
    - name: Ensure basic packages installed
      apt:
        name:
          - curl
          - tar
          - rsync
          - jq
          - lsb-release
        state: present
        update_cache: yes

    - name: Ensure data and deploy dirs exist (ext4/xfs volume)
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ tidb_user }}"
        group: "{{ tidb_user }}"
        mode: "0755"
      loop:
        - "{{ tidb_data_dir }}"
        - "{{ tidb_deploy_dir }}"

  tasks:
    - name: Ensure TiDB SSH directory exists
      file:
        path: "{{ tiup_identity_file | dirname }}"
        state: directory
        owner: "{{ tidb_user }}"
        group: "{{ tidb_user }}"
        mode: "0700"

    - name: Generate SSH key for TiDB user if missing
      become_user: "{{ tidb_user }}"
      command: >
        ssh-keygen -t ed25519 -N '' -f {{ tiup_identity_file }}
      args:
        creates: "{{ tiup_identity_file }}"

    - name: Read TiDB user SSH public key
      become_user: "{{ tidb_user }}"
      command: cat {{ tiup_identity_file }}.pub
      register: tidb_ssh_pub
      changed_when: false

    - name: Authorize TiDB user SSH key for itself
      authorized_key:
        user: "{{ tidb_user }}"
        key: "{{ tidb_ssh_pub.stdout }}"

    - name: Check if tiup is already installed
      command: "which tiup"
      register: tiup_check
      changed_when: false
      failed_when: false

    - name: Install TiUP if missing
      shell: |
        curl --proto '=https' --tlsv1.2 -sSf {{ tiup_install_script_url }} | sh
      become_user: "{{ tidb_user }}"
      when: tiup_check.rc != 0

    - name: Scan localhost host key
      become_user: "{{ tidb_user }}"
      command: "ssh-keyscan -H 127.0.0.1"
      register: localhost_host_key
      changed_when: false

    - name: Ensure localhost host key is trusted
      become_user: "{{ tidb_user }}"
      known_hosts:
        path: "/home/{{ tidb_user }}/.ssh/known_hosts"
        name: "127.0.0.1"
        key: "{{ localhost_host_key.stdout }}"
        state: present

    - name: Update tiup cluster component (optional but recommended)
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} update cluster"
      changed_when: true
      environment: "{{ tiup_env }}"

    - name: Render single-node topology.yaml
      template:
        src: ~/.slv/cmn/topo.yml
        dest: "/home/{{ tidb_user }}/topology.yaml"
        owner: "{{ tidb_user }}"
        group: "{{ tidb_user }}"
        mode: "0644"
      vars:
        _pd_client_port: "{{ pd_client_port }}"
        _pd_peer_port: "{{ pd_peer_port }}"
        _tikv_port: "{{ tikv_port }}"
        _tikv_status_port: "{{ tikv_status_port }}"
        _tidb_sql_port: "{{ tidb_sql_port }}"
        _tidb_status_port: "{{ tidb_status_port }}"
        _tiflash_tcp: "{{ tiflash_tcp }}"
        _tiflash_http: "{{ tiflash_http }}"
        _tiflash_metrics: "{{ tiflash_metrics }}"
        _tiflash_service: "{{ tiflash_service }}"
        _tidb_deploy_dir: "{{ tidb_deploy_dir }}"
        _tidb_data_dir: "{{ tidb_data_dir }}"
        _tidb_user: "{{ tidb_user }}"

    - name: Check if cluster exists
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster display {{ cluster_name }}"
      register: cluster_display
      changed_when: false
      failed_when: false
      environment: "{{ tiup_env }}"

    # ---- リセット（タイムアウト対策に async/poll を使用）----
    - name: Stop cluster (if exists) before reset
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster stop {{ cluster_name }} --force"
      when: reset and cluster_display.rc == 0
      async: 1200
      poll: 10
      changed_when: true
      ignore_errors: yes
      environment: "{{ tiup_env }}"

    - name: Destroy cluster (if exists) before reset
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster destroy {{ cluster_name }} -y --force"
      when: reset and cluster_display.rc == 0
      async: 1200
      poll: 10
      changed_when: true
      ignore_errors: yes
      environment: "{{ tiup_env }}"

    - name: Clean tiup managed data (if exists)
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster clean {{ cluster_name }} --all -y --force"
      when: reset and cluster_display.rc == 0
      async: 1200
      poll: 10
      changed_when: true
      ignore_errors: yes
      environment: "{{ tiup_env }}"

    - name: Remove old deploy/data dirs (manual cleanup)
      file:
        path: "{{ item }}"
        state: absent
      when: reset
      loop:
        - "{{ tidb_deploy_dir }}/pd-{{ pd_client_port }}"
        - "{{ tidb_deploy_dir }}/tikv-{{ tikv_port }}"
        - "{{ tidb_deploy_dir }}/tidb-{{ tidb_sql_port }}"
        - "{{ tidb_deploy_dir }}/tiflash-{{ tiflash_tcp }}"
        - "{{ tidb_deploy_dir }}/prometheus-9090"
        - "{{ tidb_deploy_dir }}/grafana-3000"
        - "{{ tidb_data_dir }}/pd-{{ pd_client_port }}"
        - "{{ tidb_data_dir }}/tikv-{{ tikv_port }}"
        - "{{ tidb_data_dir }}/tiflash-{{ tiflash_tcp }}"
        - "{{ tidb_data_dir }}/prometheus-9090"

    - name: Recreate base data dirs
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ tidb_user }}"
        group: "{{ tidb_user }}"
        mode: "0755"
      when: reset
      loop:
        - "{{ tidb_data_dir }}"
        - "{{ tidb_deploy_dir }}"

    # ---- デプロイ ----
    - name: Deploy cluster if not present or after reset
      become_user: "{{ tidb_user }}"
      shell: >
        {{ tiup_bin_path }} cluster deploy {{ cluster_name }} {{ tidb_version }}
        /home/{{ tidb_user }}/topology.yaml
        --yes --user {{ tidb_user }} --identity_file {{ tiup_identity_file }}
      args:
        chdir: "/home/{{ tidb_user }}"
        executable: /bin/bash
      register: deploy_result
      when: cluster_display.rc != 0 or reset
      environment: "{{ tiup_env }}"

    # ---- 起動シーケンス：PD → PD設定（replica=1）→ TiKV → TiDB → 残り ----
    - name: Start PD only
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster start {{ cluster_name }} --role pd"
      changed_when: true
      environment: "{{ tiup_env }}"

    - name: Set PD single-replica (max-replicas=1)
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} ctl:{{ tidb_version }} pd -u http://127.0.0.1:{{ pd_client_port }} config set max-replicas 1"
      changed_when: true
      environment: "{{ tiup_env }}"

    - name: Disable placement rules on single node
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} ctl:{{ tidb_version }} pd -u http://127.0.0.1:{{ pd_client_port }} config set enable-placement-rules false"
      changed_when: true
      environment: "{{ tiup_env }}"

    - name: Start TiKV only
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster start {{ cluster_name }} --role tikv"
      changed_when: true
      environment: "{{ tiup_env }}"

    - name: Start TiDB only
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster start {{ cluster_name }} --role tidb"
      changed_when: true
      environment: "{{ tiup_env }}"

    - name: Start remaining roles (tiflash/prometheus/grafana)
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster start {{ cluster_name }} --role tiflash,prometheus,grafana"
      changed_when: true
      failed_when: false
      environment: "{{ tiup_env }}"

    # ---- 最終表示と簡易チェック ----
    - name: Display cluster status
      become_user: "{{ tidb_user }}"
      shell: "{{ tiup_bin_path }} cluster display {{ cluster_name }}"
      register: display_result
      changed_when: false
      environment: "{{ tiup_env }}"

    - debug:
        var: display_result.stdout

    - name: Check PD stores state
      shell: 'curl -s http://127.0.0.1:{{ pd_client_port }}/pd/api/v1/stores | jq -r ".stores[].store | \"\(.id) \(.address) \(.state_name)\" "'
      register: stores
      changed_when: false
      failed_when: false

    - debug:
        var: stores.stdout

    - name: Check TiDB SQL port
      shell: "ss -ltnp | grep :{{ tidb_sql_port }}"
      register: tidb_listen
      changed_when: false
      failed_when: false

    - debug:
        var: tidb_listen.stdout
