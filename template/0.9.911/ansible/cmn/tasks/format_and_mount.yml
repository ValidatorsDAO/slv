---
- name: Check if /dev/{{ disk_name }} is already formatted
  command: blkid /dev/{{ disk_name }}
  register: blkid_result
  failed_when: false
  changed_when: false

- name: Format /dev/{{ disk_name }} to ext4 if not already formatted
  filesystem:
    fstype: ext4
    dev: "/dev/{{ disk_name }}"
  when: blkid_result.stdout == ""

- name: Get UUID for /dev/{{ disk_name }}
  command: blkid -s UUID -o value /dev/{{ disk_name }}
  register: disk_uuid_result
  changed_when: false
  retries: 5
  delay: 2
  until: disk_uuid_result.stdout | trim != ""

- name: Mount /dev/{{ disk_name }} to {{ mount_path }} using UUID
  mount:
    path: "{{ mount_path }}"
    src: "UUID={{ disk_uuid_result.stdout | trim }}"
    fstype: ext4
    state: mounted
    opts: defaults,noatime
