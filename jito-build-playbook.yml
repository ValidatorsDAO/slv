---
- name: Build and Upload Jito CLI
  hosts: all
  gather_facts: yes
  vars:
    jito_version: "{{ version | mandatory }}"
    jito_repo_url: "https://github.com/jito-foundation/jito-solana.git"
    build_dir: "/tmp/jito-build-{{ jito_version }}"
    storage_base_url: "https://storage.slv.dev/jito"
    bucket_names:
      - slv
      - slv-asia
    cloudflare_account_id: "{{ cloudflare_account_id | default(lookup('env', 'CLOUDFLARE_ACCOUNT_ID')) }}"
    cloudflare_api_token: "{{ cloudflare_api_token | default(lookup('env', 'CLOUDFLARE_API_TOKEN')) }}"
    discord_webhook_url: "{{ discord_webhook_url | default(lookup('env', 'DISCORD_WEBHOOK_URL') | default('')) }}"

  tasks:
    - name: Validate required environment variables
      assert:
        that:
          - cloudflare_account_id != ''
          - cloudflare_api_token != ''
        fail_msg: "CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN must be set"

    - name: Install build dependencies (Debian/Ubuntu)
      become: yes
      apt:
        name:
          - build-essential
          - pkg-config
          - libssl-dev
          - libudev-dev
          - libclang-dev
          - cmake
          - protobuf-compiler
          - git
          - curl
          - jq
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Check if Rust is installed
      command: rustc --version
      register: rust_check
      ignore_errors: yes
      changed_when: false

    - name: Install Rust if not present
      shell: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
      args:
        executable: /bin/bash
      when: rust_check.rc != 0

    - name: Ensure Rust is in PATH
      lineinfile:
        path: ~/.bashrc
        line: 'source $HOME/.cargo/env'
        create: yes
      when: rust_check.rc != 0

    - name: Check which artifacts already exist in R2
      uri:
        url: "{{ storage_base_url }}/{{ jito_version }}/{{ item }}"
        method: HEAD
        status_code: [200, 404]
      register: artifact_checks
      loop:
        - agave-validator
        - solana
        - solana-keygen
        - perf-libs.tar.gz
      changed_when: false

    - name: Set facts for missing artifacts
      set_fact:
        need_agave: "{{ artifact_checks.results[0].status != 200 }}"
        need_solana: "{{ artifact_checks.results[1].status != 200 }}"
        need_keygen: "{{ artifact_checks.results[2].status != 200 }}"
        need_perf: "{{ artifact_checks.results[3].status != 200 }}"

    - name: Determine if build is needed
      set_fact:
        skip_build: "{{ not (need_agave or need_solana or need_keygen or need_perf) }}"

    - name: Display build status
      debug:
        msg: |
          Jito version: {{ jito_version }}
          agave-validator: {{ 'Missing' if need_agave else 'Exists' }}
          solana: {{ 'Missing' if need_solana else 'Exists' }}
          solana-keygen: {{ 'Missing' if need_keygen else 'Exists' }}
          perf-libs.tar.gz: {{ 'Missing' if need_perf else 'Exists' }}
          Skip build: {{ skip_build }}

    - block:
        - name: Clean up previous build directory if exists
          file:
            path: "{{ build_dir }}"
            state: absent

        - name: Clone Jito repository
          git:
            repo: "{{ jito_repo_url }}"
            dest: "{{ build_dir }}"
            version: "{{ jito_version }}"
            recursive: yes
            force: yes

        - name: Build Jito binaries
          shell: |
            source $HOME/.cargo/env
            ./scripts/cargo-install-all.sh .
          args:
            chdir: "{{ build_dir }}"
            executable: /bin/bash
          environment:
            RUST_BACKTRACE: 1
          when: need_agave or need_solana or need_keygen or need_perf

        - name: Collect solana binary
          copy:
            src: "{{ build_dir }}/target/release/solana"
            dest: "/tmp/solana-{{ jito_version }}"
            mode: '0755'
            remote_src: yes
          when: need_solana

        - name: Collect solana-keygen binary
          copy:
            src: "{{ build_dir }}/target/release/solana-keygen"
            dest: "/tmp/solana-keygen-{{ jito_version }}"
            mode: '0755'
            remote_src: yes
          when: need_keygen

        - name: Collect agave-validator binary
          copy:
            src: "{{ build_dir }}/target/release/agave-validator"
            dest: "/tmp/agave-validator-{{ jito_version }}"
            mode: '0755'
            remote_src: yes
          when: need_agave

        - name: Check for perf-libs directory or symlink
          stat:
            path: "{{ build_dir }}/target/release/perf-libs"
          register: perf_libs_stat
          when: need_perf

        - name: Find real perf-libs directory
          shell: |
            cd {{ build_dir }}/target/release
            if [ -L perf-libs ]; then
              readlink -f perf-libs
            elif [ -d perf-libs ]; then
              echo "{{ build_dir }}/target/release/perf-libs"
            elif [ -d ../perf-libs ]; then
              echo "{{ build_dir }}/target/perf-libs"
            else
              echo ""
            fi
          register: real_perf_dir
          when: need_perf
          changed_when: false

        - name: Build perf-libs if not found
          shell: |
            source $HOME/.cargo/env
            if [ -f scripts/build-perf-libs.sh ]; then
              ./scripts/build-perf-libs.sh
            elif [ -f perf/build.sh ]; then
              cd perf && ./build.sh
            fi
          args:
            chdir: "{{ build_dir }}"
            executable: /bin/bash
          when: need_perf and real_perf_dir.stdout == ""

        - name: Re-check for perf-libs after build
          shell: |
            cd {{ build_dir }}/target/release
            if [ -L perf-libs ]; then
              readlink -f perf-libs
            elif [ -d perf-libs ]; then
              echo "{{ build_dir }}/target/release/perf-libs"
            elif [ -d ../perf-libs ]; then
              echo "{{ build_dir }}/target/perf-libs"
            else
              echo ""
            fi
          register: real_perf_dir_final
          when: need_perf and real_perf_dir.stdout == ""
          changed_when: false

        - name: Set final perf directory
          set_fact:
            perf_directory: "{{ real_perf_dir_final.stdout if real_perf_dir.stdout == '' else real_perf_dir.stdout }}"
          when: need_perf

        - name: Create perf-libs archive
          shell: |
            if [ -f "{{ perf_directory }}/solana-perf.tgz" ]; then
              cp "{{ perf_directory }}/solana-perf.tgz" "/tmp/perf-libs-{{ jito_version }}.tar.gz"
            else
              tar -C "{{ perf_directory }}" -czf "/tmp/perf-libs-{{ jito_version }}.tar.gz" .
            fi
          when: need_perf and perf_directory != ""

        - name: Upload solana binary to R2 buckets
          shell: |
            for BUCKET_NAME in {{ bucket_names | join(' ') }}; do
              curl -s -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/${BUCKET_NAME}/objects/jito/{{ jito_version }}/solana" \
                -H "Authorization: Bearer {{ cloudflare_api_token }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@/tmp/solana-{{ jito_version }}"
            done
          when: need_solana

        - name: Upload solana-keygen binary to R2 buckets
          shell: |
            for BUCKET_NAME in {{ bucket_names | join(' ') }}; do
              curl -s -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/${BUCKET_NAME}/objects/jito/{{ jito_version }}/solana-keygen" \
                -H "Authorization: Bearer {{ cloudflare_api_token }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@/tmp/solana-keygen-{{ jito_version }}"
            done
          when: need_keygen

        - name: Upload agave-validator binary to R2 buckets
          shell: |
            for BUCKET_NAME in {{ bucket_names | join(' ') }}; do
              curl -s -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/${BUCKET_NAME}/objects/jito/{{ jito_version }}/agave-validator" \
                -H "Authorization: Bearer {{ cloudflare_api_token }}" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@/tmp/agave-validator-{{ jito_version }}"
            done
          when: need_agave

        - name: Upload perf-libs archive to R2 buckets
          shell: |
            for BUCKET_NAME in {{ bucket_names | join(' ') }}; do
              curl -s -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/${BUCKET_NAME}/objects/jito/{{ jito_version }}/perf-libs.tar.gz" \
                -H "Authorization: Bearer {{ cloudflare_api_token }}" \
                -H "Content-Type: application/gzip" \
                --data-binary "@/tmp/perf-libs-{{ jito_version }}.tar.gz"
            done
          when: need_perf

        - name: Update latest.txt in both buckets
          uri:
            url: "https://api.cloudflare.com/client/v4/accounts/{{ cloudflare_account_id }}/r2/buckets/{{ item }}/objects/jito/latest.txt"
            method: PUT
            headers:
              Authorization: "Bearer {{ cloudflare_api_token }}"
              Content-Type: "text/plain"
            body: "{{ jito_version }}"
            status_code: 200
          loop: "{{ bucket_names }}"

        - name: Send Discord notification
          uri:
            url: "{{ discord_webhook_url }}"
            method: POST
            headers:
              Content-Type: "application/json"
            body_format: json
            body:
              embeds:
                - title: "âš¡ New/Updated Jito CLI Artifacts"
                  description: "Uploaded missing artifacts for {{ jito_version }}"
                  color: 16776960
                  fields:
                    - name: "Version"
                      value: "{{ jito_version }}"
                      inline: true
                    - name: "agave-validator"
                      value: "{{ storage_base_url }}/{{ jito_version }}/agave-validator"
                      inline: false
                    - name: "solana"
                      value: "{{ storage_base_url }}/{{ jito_version }}/solana"
                      inline: false
                    - name: "solana-keygen"
                      value: "{{ storage_base_url }}/{{ jito_version }}/solana-keygen"
                      inline: false
                    - name: "perf-libs.tar.gz"
                      value: "{{ storage_base_url }}/{{ jito_version }}/perf-libs.tar.gz"
                      inline: false
                  timestamp: "{{ ansible_date_time.iso8601 }}"
            status_code: [200, 204]
          when: discord_webhook_url is defined

      when: not skip_build

    - name: Clean up build directory
      file:
        path: "{{ build_dir }}"
        state: absent
      when: not skip_build

    - name: Clean up temporary files
      file:
        path: "/tmp/{{ item }}-{{ jito_version }}"
        state: absent
      loop:
        - solana
        - solana-keygen
        - agave-validator
      when: not skip_build

    - name: Clean up perf-libs archive
      file:
        path: "/tmp/perf-libs-{{ jito_version }}.tar.gz"
        state: absent
      when: not skip_build

    - name: Final message
      debug:
        msg: |
          {% if skip_build %}
          All artifacts for version {{ jito_version }} already exist. No action taken.
          {% else %}
          Successfully built and uploaded Jito CLI version {{ jito_version }}
          {% endif %}